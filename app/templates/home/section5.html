<section id="section-ca0a9a64-8a0e-424b-ad5b-5e92793c1891">
  <div id="root">
    <section id="upload-section" class="py-20 bg-white">
      <div id="phase-2" class="container mx-auto px-4">
        <div class="text-center mb-16">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
            AI Template & Content Generation
          </h2>
          <p class="text-lg text-gray-600 max-w-3xl mx-auto">
            Upload your DOCX file and let our AI analyze and split it based on
            the table of contents structure.
          </p>
        </div>

        <div class="max-w-4xl mx-auto">
          <!-- File Upload Area -->
          <div
            id="upload-area-phase2"
            class="border-2 border-dashed border-blue-300 rounded-lg p-10 mb-8 text-center transition-all duration-300 bg-blue-50 hover:bg-blue-100"
          >
            <div id="upload-default-phase2" class="block">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-16 w-16 mx-auto text-blue-500 mb-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                ></path>
              </svg>
              <h3 class="text-xl font-semibold text-gray-800 mb-2">
                Drag &amp; Drop Your DOCX File Here
              </h3>
              <p class="text-gray-600 mb-4">or</p>
              <button
                id="browse-button-phase2"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md transition-colors duration-300"
              >
                Browse Files
              </button>
              <input
                type="file"
                id="file-input-phase2"
                accept=".docx"
                class="hidden"
              />
              <p class="text-sm text-gray-500 mt-4">Supported format: .docx</p>
            </div>

            <div id="upload-dragover-phase2" class="hidden">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-16 w-16 mx-auto text-blue-600 mb-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              <h3 class="text-xl font-semibold text-blue-700 mb-2">
                Drop Your File to Start Processing
              </h3>
            </div>

            <div id="upload-processing-phase2" class="hidden">
              <div
                class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mx-auto mb-4"
              ></div>
              <h3 class="text-xl font-semibold text-gray-800 mb-2">
                Processing Your Document
              </h3>
              <p class="text-gray-600 mb-4">
                Please wait while our AI analyzes your file...
              </p>
              <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div
                  id="progress-indicator-phase2"
                  class="bg-blue-600 h-2.5 rounded-full w-0 transition-all duration-500"
                ></div>
              </div>
              <p id="progress-text-phase2" class="text-sm text-gray-500">0%</p>
            </div>
          </div>

          <!-- Results Area (Initially Hidden) -->
          <div
            id="results-area-phase2"
            class="hidden bg-white rounded-lg shadow-lg p-6 transition-all duration-500"
          >
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-xl font-bold text-gray-800">
                Document Structure
              </h3>
              <div>
                <!-- <button
                  id="download-all-button-phase2"
                  class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-300 mr-2"
                >
                  Download All
                </button> -->
                <button
                  id="restart-button-phase2"
                  class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-md transition-colors duration-300"
                >
                  New Upload
                </button>
              </div>
            </div>

            <div class="border rounded-md">
              <!-- File Name Header -->
              <div class="bg-gray-100 px-4 py-3 flex items-center border-b">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 text-blue-600 mr-2"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  ></path>
                </svg>
                <span id="filename-phase2" class="font-medium"
                  >document.docx</span
                >
              </div>

              <!-- Document Structure Preview -->
              <div id="document-structure" class="divide-y">
                <!-- Example Section 1 -->
                <!-- <div
                  class="px-4 py-3 hover:bg-gray-50 flex justify-between items-center"
                >
                  <div class="flex items-center">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5 text-gray-500 mr-2"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                      ></path>
                    </svg>
                    <span>1. Introduction</span>
                  </div>
                  <button
                    class="text-blue-600 hover:text-blue-800 font-medium text-sm"
                  >
                    Download
                  </button>
                </div> -->
      
              
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Floating Action Button -->
    <div id="floating-upload-button" class="fixed bottom-8 right-8 z-40">
      <a
      class="flex items-center justify-center h-14 w-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg transition-transform duration-300 hover:scale-110 focus:outline-none"
      >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
        ></path>
      </svg>
      </a>
    </div>

    <!-- Animated Plans -->
    <div id="animated-plans" class="fixed bottom-24 right-8 z-40 hidden"> 
      
      <a href="#upload-section">
        <button
        class="bg-blue-500 hover:from-blue-600 hover:to-blue-800 text-white font-medium py-2 px-4 rounded-full shadow-lg transition-transform duration-300 transform hover:scale-105 w-3/4 mb-2"
      >
      Create Plan
      </button>
      </a>
      <a href="#phase-1">
      <button
        class="bg-blue-500 hover:from-blue-600 hover:to-blue-800 text-white font-medium py-2 px-4 rounded-full shadow-lg transition-transform duration-300 transform hover:scale-105 w-3/4 mb-2"
      >
        Generate Template
      </button>
      </a>
      </div>
    </div>

    <style>
      @keyframes slide-in-right {
      0% {
        transform: translateX(100%);
        opacity: 0;
      }
      100% {
        transform: translateX(0);
        opacity: 1;
      }
      }
      @keyframes slide-out-right {
      0% {
        transform: translateX(0);
        opacity: 1;
      }
      100% {
        transform: translateX(100%);
        opacity: 0;
      }
      }
      .animate-slide-in-right {
      animation: slide-in-right 0.5s ease-out forwards;
      }
      .animate-slide-out-right {
      animation: slide-out-right 0.5s ease-out forwards;
      }
    </style>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
      const floatingButton = document.getElementById("floating-upload-button");
      const animatedPlans = document.getElementById("animated-plans");

      floatingButton.addEventListener("click", function () {
        if (animatedPlans.classList.contains("hidden")) {
        animatedPlans.classList.remove("hidden");
        animatedPlans.classList.remove("animate-slide-out-right");
        animatedPlans.classList.add("animate-slide-in-right");
        } else {
        animatedPlans.classList.remove("animate-slide-in-right");
        animatedPlans.classList.add("animate-slide-out-right");
        setTimeout(() => {
          animatedPlans.classList.add("hidden");
        }, 500); // Match the duration of the slide-out animation
        }
      });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Elements
        const uploadArea = document.getElementById("upload-area-phase2");
        const uploadDefault = document.getElementById("upload-default-phase2");
        const uploadDragover = document.getElementById(
          "upload-dragover-phase2"
        );
        const documentStructure = document.getElementById(
          "document-structure"
        );
    

        const uploadProcessing = document.getElementById(
          "upload-processing-phase2"
        );
        const fileInput = document.getElementById("file-input-phase2");
        const browseButton = document.getElementById("browse-button-phase2");
        const progressIndicator = document.getElementById(
          "progress-indicator-phase2"
        );
        const progressText = document.getElementById("progress-text-phase2");
        const resultsArea = document.getElementById("results-area-phase2");
        const restartButton = document.getElementById("restart-button-phase2");
        const downloadAllButton = document.getElementById(
          "download-all-button-phase2"
        );
        const filename = document.getElementById("filename-phase2");

        // Drag and drop functionality
        uploadArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          uploadDefault.classList.add("hidden");
          uploadDragover.classList.remove("hidden");
          uploadArea.classList.add("border-blue-500");
          uploadArea.classList.add("bg-blue-100");
        });

        
        uploadArea.addEventListener("dragleave", function (e) {
          e.preventDefault();
          uploadDefault.classList.remove("hidden");
          uploadDragover.classList.add("hidden");
          uploadArea.classList.remove("border-blue-500");
          uploadArea.classList.remove("bg-blue-100");
        });

        uploadArea.addEventListener("drop",async function (e) {
          e.preventDefault();
          const files = e.dataTransfer.files;
          await handleFile(files[0]);
        });

        // Browse button functionality
        browseButton.addEventListener("click", function () {
          fileInput.click();
        });

        fileInput.addEventListener("change",async function () {
          if (fileInput.files.length > 0) {
            console.log('change event is triggered !');
            await handleFile(fileInput.files[0]);
          }
        });

        // Restart button functionality
        restartButton.addEventListener("click", function () {
          resultsArea.classList.add("hidden");
          uploadDefault.classList.remove("hidden");
          uploadProcessing.classList.add("hidden");
          uploadArea.classList.remove("hidden");
          fileInput.value = "";
          progressIndicator.style.width = "0%";
          progressText.textContent = "0%";
        });

        async function handleFile(file) {
          console.log("called handleFile !");
          if (file && file.name.endsWith(".docx")) {

            // Update UI for processing
            uploadDefault.classList.add("hidden");
            uploadDragover.classList.add("hidden");
            uploadProcessing.classList.remove("hidden");
            uploadArea.classList.remove("border-blue-500");
            // Set filename
            filename.textContent = file.name;

            //create a zip file 
            const zip = new JSZip();
            if (file) zip.file(file.name, file);

            try {
              // Generate the zip file
              const zipFile = await zip.generateAsync({ type: "blob" });
              // Create FormData and append file
              const formData = new FormData();
              formData.append("zip_file", zipFile);
      
              // Send request to upload endpoint with JWT token in headers
              const response =await fetch("/upload-phase2", {
                method: "POST",
                body: formData,
                credentials: "include",
              })


               if (!response.ok) {
                throw new Error(`Server error: ${response.statusText}`);
              }

              if (response.redirected) {
                  console.log("Redirect detected to:", response.url);
                  window.location.href = response.url; // Redirect the browser
                  return; // Exit the function early
                }

              const data = await response.json();
              data.files.forEach(doc => { 
                // const docUrl =downloadFile(doc.docxurl)
                const docElement = createDocumentList(doc.filename, doc.docxurl);
                documentStructure.appendChild(docElement);
              });

              // Show success UI
              uploadArea.classList.add("hidden");
              resultsArea.classList.remove("hidden");

            } catch (error) {
              alert("An error occurred during upload");
              uploadDefault.classList.remove("hidden");
              uploadProcessing.classList.add("hidden");
              console.error("Error during processing:", error);
            }

          } else {
            console.log("file is not a docx file !");
            alert("Please upload a valid DOCX file.");
            uploadDefault.classList.remove("hidden");
            uploadDragover.classList.add("hidden");
          }
        }

        function simulateProcessing() {
          let progress = 0;
          const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 100) progress = 100;

            progressIndicator.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;

            if (progress === 100) {
              clearInterval(interval);
              // Show results after a brief delay
              setTimeout(() => {
                uploadArea.classList.add("hidden");
                resultsArea.classList.remove("hidden");
              }, 500);
            }
          }, 600);
        }

      function createDocumentList(filename, fileUrl) {
        console.log('filename:', filename);
        console.log('fileUrl:', fileUrl);
        // Create the container div
        const container = document.createElement('div');
        container.className = 'px-4 py-3 hover:bg-gray-50 flex justify-between items-center';

        // Create the left section with the icon and filename
        const leftSection = document.createElement('div');
        leftSection.className = 'flex items-center';

        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        icon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        icon.setAttribute('class', 'h-5 w-5 text-gray-500 mr-2');
        icon.setAttribute('fill', 'none');
        icon.setAttribute('viewBox', '0 0 24 24');
        icon.setAttribute('stroke', 'currentColor');

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('d', 'M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z');

        icon.appendChild(path);

        const fileNameSpan = document.createElement('span');
        fileNameSpan.textContent = filename;

        leftSection.appendChild(icon);
        leftSection.appendChild(fileNameSpan);

        // Create the download button
        const downloadButton = document.createElement('a');
        downloadButton.className = 'text-blue-600 hover:text-blue-800 font-medium text-sm';
        downloadButton.href = fileUrl;
        downloadButton.download = filename;
        downloadButton.textContent = 'Download';

        // Assemble the container
        container.appendChild(leftSection);
        container.appendChild(downloadButton);

        return container;
      }


      async function downloadFile(fileUrl) {
        console.log('fileUrl:', fileUrl);
        try {
          const response = await fetch(fileUrl, {
            mode: 'cors',
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const blob = await response.blob();
          const blobUrl = window.URL.createObjectURL(blob);
          console.log('Blob URL:', blobUrl);

          return blobUrl; 
        } catch (error) {

            console.error('Download failed:', error);
            throw new Error('An error occurred while downloading the file.');
        }
      }


      });
    </script>
  </div>
</section>
